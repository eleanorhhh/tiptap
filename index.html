<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <title>æˆ‘çš„ Tiptap å­¸ç¿’ç­†è¨˜</title>
    <style>
        .editor-container {
            border: 2px solid #ccc;
            padding: 20px;
            border-radius: 8px;
            min-height: 200px;
            margin-top: 10px;
            outline: none;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* CSS å¯¦ä½œ Placeholder */
        #editor:empty::before {
            content: attr(data-placeholder);
            color: #adb5bd;
            font-style: italic;
            pointer-events: none;
        }

        /* ä¿®æ­£å¾Œçš„ Placeholder CSS */
        .ProseMirror p.is-editor-empty:first-child::before {
            content: attr(data-placeholder);
            float: left;
            color: #adb5bd;
            /* é€æ˜æ„Ÿçš„ç°è‰² */
            pointer-events: none;
            height: 0;
        }

        .ProseMirror:focus {
            outline: none;
        }

        .toolbar button {
            margin-right: 5px;
            padding: 5px 10px;
            cursor: pointer;
        }

        /* é¸å–®æ¨£å¼å¼·åŒ– */
        #slash-menu {
            display: none;
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-radius: 6px;
            width: 150px;
        }

        #menu-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #menu-list li {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        /* é—œéµï¼šé¸ä¸­æ™‚çš„èƒŒæ™¯é¡è‰² */
        #menu-list li.selected {
            background-color: #007bff;
            color: white;
        }
    </style>
</head>

<body>

    <h2>Tiptap ç·¨è¼¯å™¨æ¸¬è©¦</h2>
    <div class="toolbar">
        <button onclick="toggleBold()">åŠ ç²— (Bold)</button>
        <button onclick="toggleHeading()">æ¨™é¡Œ (H1)</button>
        <button onclick="saveContent()">å„²å­˜åˆ° Django</button>
    </div>

    <div id="slash-menu">
        <ul id="menu-list"></ul>
    </div>

    <div id="editor" class="editor-container" data-placeholder="è¼¸å…¥ / æ¸¬è©¦éµç›¤é¸æ“‡ï¼"></div>
    <div style="margin-top: 50px;">
        <div style="margin-top: 40px; border-top: 1px solid #eee; padding-top: 20px;">
            <h3>ğŸ“ æ­·å²ç­†è¨˜ç´€éŒ„</h3>
            <div id="history-list" style="display: flex; flex-direction: column; gap: 10px;">
            </div>
        </div>
    </div>
        <script type="module">
            import { Editor, Extension } from 'https://esm.sh/@tiptap/core'
            import StarterKit from 'https://esm.sh/@tiptap/starter-kit'
            import Suggestion from 'https://esm.sh/@tiptap/suggestion'
            import Placeholder from 'https://esm.sh/@tiptap/extension-placeholder'

            const CustomSlashCommand = Extension.create({
                name: 'customSlashCommand',
                addProseMirrorPlugins() {
                    return [
                        Suggestion({
                            editor: this.editor,
                            char: '/',
                            items: ({ query }) => {
                                return [
                                    { title: 'æ¨™é¡Œ 1', command: ({ editor, range }) => editor.chain().focus().deleteRange(range).setNode('heading', { level: 1 }).run() },
                                    { title: 'æ¨™é¡Œ 2', command: ({ editor, range }) => editor.chain().focus().deleteRange(range).setNode('heading', { level: 2 }).run() },
                                    { title: 'ç²—é«”', command: ({ editor, range }) => editor.chain().focus().deleteRange(range).setMark('bold').run() },
                                ].filter(item => item.title.toLowerCase().startsWith(query.toLowerCase())).slice(0, 10)
                            },
                            render: () => {
                                const menu = document.querySelector('#slash-menu');
                                const list = document.querySelector('#menu-list');
                                let selectedIndex = 0;
                                let localItems = []; // æœ¬åœ°å„²å­˜ç•¶å‰çš„é …ç›®æ¸…å–®

                                const updateSelection = () => {
                                    const domItems = list.querySelectorAll('li');
                                    domItems.forEach((li, index) => {
                                        if (index === selectedIndex) {
                                            li.style.backgroundColor = '#007bff';
                                            li.style.color = 'white';
                                        } else {
                                            li.style.backgroundColor = 'transparent';
                                            li.style.color = 'black';
                                        }
                                    });
                                };

                                return {
                                    onStart: props => {
                                        localItems = props.items || []; // ç¢ºä¿ items å­˜åœ¨
                                        selectedIndex = 0;

                                        list.innerHTML = localItems.map((item, index) =>
                                            `<li style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee;">${item.title}</li>`
                                        ).join('');

                                        const { clientRect } = props;
                                        menu.style.display = 'block';
                                        menu.style.left = `${clientRect().left}px`;
                                        menu.style.top = `${clientRect().top + 25}px`;

                                        window.currentProps = props;
                                        updateSelection();

                                        list.querySelectorAll('li').forEach((li, index) => {
                                            li.onclick = () => window.executeSlash(index);
                                        });
                                    },

                                    // ä¿®æ­£ï¼šä½¿ç”¨æ›´ç©©å¥çš„åƒæ•¸æ¥æ”¶æ–¹å¼
                                    onKeyDown: (props) => {
                                        const { event } = props;
                                        // æŸäº›ç‰ˆæœ¬ä¸­ items å¯èƒ½åœ¨ props.items è£¡
                                        const items = props.items || localItems;

                                        if (!items || items.length === 0) return false;

                                        if (event.key === 'ArrowUp') {
                                            selectedIndex = (selectedIndex + items.length - 1) % items.length;
                                            updateSelection();
                                            return true;
                                        }

                                        if (event.key === 'ArrowDown') {
                                            selectedIndex = (selectedIndex + 1) % items.length;
                                            updateSelection();
                                            return true;
                                        }

                                        if (event.key === 'Enter') {
                                            window.executeSlash(selectedIndex);
                                            return true;
                                        }

                                        return false;
                                    },

                                    onExit: () => {
                                        menu.style.display = 'none';
                                        localItems = [];
                                    },
                                }
                            }
                        }),
                    ]
                },
            })

            const editor = new Editor({
                element: document.querySelector('#editor'),
                extensions: [
                    StarterKit,
                    CustomSlashCommand,
                    // 2. å•Ÿå‹• Placeholder æ“´å±•
                    Placeholder.configure({
                        // å®ƒæœƒå»è®€å– HTML ä¸Šçš„ data-placeholder å±¬æ€§
                        placeholder: ({ node }) => {
                            return document.querySelector('#editor').getAttribute('data-placeholder')
                        },
                    }),
                ],
                content: '', // ä¿æŒç‚ºç©º
                autofocus: true,
            })


            window.toggleBold = () => editor.chain().focus().toggleBold().run();
            window.toggleHeading = () => editor.chain().focus().toggleHeading({ level: 1 }).run();

            window.executeSlash = (index) => {
                const props = window.currentProps;
                if (props && props.items[index]) {
                    props.items[index].command(props);
                    document.querySelector('#slash-menu').style.display = 'none';
                }
            };

            // å„²å­˜è‡³ django
            window.saveContent = async () => {
                const jsonContent = editor.getJSON();
                
                try {
                    const response = await fetch('http://127.0.0.1:8000/api/save/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ body_content: jsonContent })
                    });
                    const result = await response.json();

                    if (response.ok) {
                        alert('å„²å­˜æˆåŠŸï¼ID: ' + result.id);
                            
                        // --- é—œéµä¿®æ­£ï¼šå„²å­˜æˆåŠŸå¾Œï¼Œç«‹å³é‡æ–°æ•´ç†ä¸‹æ–¹ç´€éŒ„ ---
                        // å»ºè­°å‘¼å« loadHistoryListï¼Œå› ç‚ºä½ çš„ä»£ç¢¼ä¸­å®ƒåŒ…å«äº†é‚„åŸåŠŸèƒ½
                        if (typeof loadHistoryList === 'function') {
                            loadHistoryList();
                        }
                        // å¦‚æœä½ æƒ³ç”¨å¦ä¸€å€‹å‡½å¼åï¼Œä¹Ÿå¯ä»¥æ”¹å‘¼å« refreshHistoryList();
                    }
                } catch (e) {
                    alert('å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Django ä¼ºæœå™¨æ˜¯å¦é–‹å•Ÿ');
                }
            };

            async function refreshHistoryList() {
                try {
                    const response = await fetch('http://127.0.0.1:8000/api/load_all/');
                    const result = await response.json();
                    const historyList = document.querySelector('#history-list');

                    if (result.status === 'success' && result.notes) {
                        // å°‡æ‰€æœ‰ç­†è¨˜æ˜ å°„æˆ HTML å­—ä¸²
                        historyList.innerHTML = result.notes.map(note => {
                            // å®‰å…¨åœ°å–å¾—ç¬¬ä¸€è¡Œæ–‡å­—ä½œç‚ºé è¦½
                            const previewText = note.body_content?.content?.[0]?.content?.[0]?.text || "ç„¡æ¨™é¡Œ";
                            return `
                            <div style="padding: 10px; border: 1px solid #eee; margin-bottom: 5px; cursor: pointer; border-radius: 4px;" 
                                onclick="restoreNote(${JSON.stringify(note.body_content).replace(/"/g, '&quot;')})">
                                <strong>${previewText}</strong>
                                <div style="font-size: 12px; color: #888;">${note.created_at}</div>
                            </div>
                        `;
                        }).join('');
                    }
                } catch (error) {
                    console.error('è¼‰å…¥æ­·å²æ¸…å–®å¤±æ•—:', error);
                }
            }

            // é»æ“Šå¾Œå°‡å…§å®¹æ”¾å›ç·¨è¼¯å™¨
            window.restoreNote = (content) => {
                editor.commands.setContent(content);
            };

            // åˆå§‹åŸ·è¡Œ
            refreshHistoryList();
            // 1. æŠ“å–æ‰€æœ‰ç­†è¨˜ä¸¦é¡¯ç¤ºåœ¨æ­·å²æ¸…å–®
            async function loadHistoryList() {
                try {
                    // ä½¿ç”¨ä½ ä¹‹å‰æ¸¬è©¦æˆåŠŸçš„ API æ¦‚å¿µ
                    const response = await fetch('http://127.0.0.1:8000/api/load_all/');
                    const result = await response.json();
                    const historyList = document.querySelector('#history-list');

                    if (result.status === 'success' && result.notes.length > 0) {
                        historyList.innerHTML = result.notes.map(note => {
                            const previewText = note.body_content?.content?.[0]?.content?.[0]?.text || "ç„¡æ–‡å­—å…§å®¹";
                            const date = new Date(note.created_at).toLocaleString();

                            return `
        <div style="padding: 12px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
            <div onclick="restoreNoteById(${note.id})" style="cursor: pointer; flex-grow: 1;">
                <div style="font-weight: bold; color: #333;">${previewText}</div>
                <div style="font-size: 12px; color: #888;">${date}</div>
            </div>
            <button onclick="deleteNote(${note.id})" 
                    style="background: #ff4d4f; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                åˆªé™¤
            </button>
        </div>
    `;
                        }).join('');
                    } else {
                        historyList.innerHTML = "ç›®å‰å°šç„¡ä»»ä½•ç´€éŒ„ã€‚";
                    }
                } catch (error) {
                    console.log("å°šæœªå¯¦ä½œ load_all API æˆ–é€£ç·šå¤±æ•—");
                }
            }

            // 2. è®“é»æ“Šæ­·å²ç´€éŒ„å¯ä»¥é‚„åŸå…§å®¹
            window.restoreNoteById = async (id) => {
                try {
                    // é€é ID è®€å–ç‰¹å®šç­†è¨˜
                    const response = await fetch(`http://127.0.0.1:8000/api/load/?id=${id}`);
                    const result = await response.json();

                    if (result.status === 'success' && result.body_content) {
                        editor.commands.setContent(result.body_content);
                        window.scrollTo({ top: 0, behavior: 'smooth' }); // æ²å‹•å›é ‚ç«¯ç·¨è¼¯
                    }
                } catch (error) {
                    alert("é‚„åŸç­†è¨˜å¤±æ•—");
                }
            };

            // åˆå§‹åŸ·è¡Œè¼‰å…¥æ¸…å–®
            loadHistoryList();
            window.deleteNote = async (id) => {
                if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç­†è¨˜å—ï¼Ÿ')) return;

                try {
                    const response = await fetch(`http://127.0.0.1:8000/api/delete/${id}/`, {
                        method: 'DELETE',
                    });
                    const result = await response.json();

                    if (result.status === 'success') {
                        alert('åˆªé™¤æˆåŠŸ');
                        loadHistoryList(); // é—œéµï¼šåˆªé™¤å¾Œç«‹å³é‡æ–°æ•´ç†æ¸…å–®ï¼Œé é¢ä¸éœ€è¦åˆ·æ–°ï¼
                    }
                } catch (error) {
                    alert('åˆªé™¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
                }
            };
        </script>
</body>

</html>